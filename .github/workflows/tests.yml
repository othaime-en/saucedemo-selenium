name: ðŸ§ª SauceDemo Test Suite

# Trigger conditions
on:
  push:
    branches: [main, develop] # Run on pushes to main and develop branches
  pull_request:
    branches: [main] # Run on PRs to main branch
  schedule:
    - cron: "0 2 * * *" # Run daily at 2 AM UTC (smoke tests)
  workflow_dispatch: # Allow manual triggering

# Environment variables available to all jobs
env:
  NODE_VERSION: "18"
  HEADLESS: true
  CI: true

jobs:
  # Job 1: Run tests on different Node.js versions (compatibility testing)
  test-matrix:
    name: ðŸ§ª Test on Node ${{ matrix.node-version }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16, 18, 20] # Test on multiple Node.js versions

    steps:
      # Step 1: Checkout the code
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js environment
      - name: ðŸš€ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      # Step 3: Install dependencies
      - name: ðŸ“¥ Install Dependencies
        run: |
          npm ci
          npm ls > /dev/null 2>&1

      # Step 4: Setup Chrome browser for testing
      - name: ðŸŒ Setup Chrome Browser
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable

      # Step 5: Run linting (code quality check)
      - name: ðŸ” Run Code Linting
        run: npm run lint > /dev/null 2>&1
        continue-on-error: true # Don't fail the build on linting errors

      # Step 6: Run the test suite
      - name: ðŸ§ª Run Test Suite
        run: |
          echo "Running tests with Node.js ${{ matrix.node-version }}"
          npm run test:e2e > /dev/null 2>&1
        env:
          BROWSER: chrome
          HEADLESS: true

      # Step 7: Upload test artifacts (screenshots, reports)
      - name: ðŸ“¸ Upload Test Artifacts
        uses: actions/upload-artifact@v4
        if: always() # Always upload, even if tests fail
        with:
          name: test-artifacts-node-${{ matrix.node-version }}
          path: |
            reports/
            !reports/*.tmp
          retention-days: 7

      # Step 8: Upload test results
      - name: ðŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-node-${{ matrix.node-version }}
          path: test-results.xml
          retention-days: 30
